{% extends "base.html" %}

{% block content %}
    <h1>Welcome, {{ user.email }}</h1>
    <p>You are logged in. This is the dashboard.</p>
    <button id="sync-transactions">Sync transactions</button>
    

    <form method = "get">
            <input type="radio" name="type" value="all" {% if filter_type == 'all' %}checked{% endif %}>
            All
        </label>
        <label style="margin-left:10px;">
            <input type="radio" name="type" value="income" {% if filter_type == 'income' %}checked{% endif %}>
            Income
        </label>
        <label style="margin-left:10px;">
            <input type="radio" name="type" value="expense" {% if filter_type == 'expense' %}checked{% endif %}>
            Expense
        </label>
            <input type = "text" name = "search" placeholder = "Search description" value = "{{ search_query }}">
            <button type = "submit">Filter</button>
            <a href = "{% url 'dashboard' %}">Reset</a>
        </form>

    <p><strong>Total income: </strong>{{ income }}</p>
    <p><strong>Total expenses: </strong>{{ expenses }}</p>
    <p><strong>Balance: </strong>{{ balance }}</p>

    <h2>Transactions for this month</h2>
    <ul>
        {% for transaction in transactions %}
            <li>
                {{ transaction.date }} — {{ transaction.type }} — {{ transaction.description }} — {{ transaction.amount }}
            </li>
        {% empty %}
            <li>No transactions this month.</li>
        {% endfor %}
    </ul>

    <a href="{% url 'feedback' %}">Have feedback?</a>
    <a href="{% url 'feedback_list' %}">View your feedback</a>
    <a href="{% url 'list_transactions' %}">Check all transactions</a>
    <a href="{% url 'add_transaction' %}">Add a transaction</a>

    {% csrf_token %}
    <script>
        document.addEventListener('DOMContentLoaded', () =>{
            const syncButton = document.getElementById("sync-transactions");

            const messageArea = document.createElement("div");
            messageArea.style.marginTop = "10px";
            syncButton.parentNode.insertBefore(messageArea, syncButton.nextSibling);

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            syncButton.addEventListener('click', async () =>{
                messageArea.textContent = 'Syncing...';
                messageArea.style.color = 'blue';

                try {
                    const response = await fetch('{% url "sync_transactions" %}',{
                        method : 'POST',
                        headers : {
                            'Content-Type' : 'application/json',
                            'X-CSRFToken' : csrfToken,
                        },
                        body : JSON.stringify({}),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        
                        messageArea.textContent = `Success! Synced ${result.synced_count} transactions.`;
                        messageArea.style.color = 'green';
                        
                        setTimeout(() => {window.location.reload();}, 1000);
                    } else {
                        messageArea.textContent = `Error ${result.error}.`;  // ` template literal
                        messageArea.style.color = 'red';
                    }
                } catch (error) {
                    messageArea.textContent = `An error occured: ${error.message}.`;
                    messageArea.style.color = 'red';

                }
            })
        })
    </script>
    
{% endblock content %}
